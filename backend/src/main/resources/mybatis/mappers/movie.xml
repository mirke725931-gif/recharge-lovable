<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.recharge.backend.movie.dao.MovieDAO">

    <resultMap id="MovieMap" type="com.recharge.backend.movie.vo.MovieVO">
        <id     column="MOVIE_ID"              property="movieId"/>
        <result column="MOVIE_POSTER"          property="poster"/>
        <result column="MOVIE_BACKDROP"        property="backdrop"/>
        <result column="MOVIE_TITLE"           property="title"/>
        <result column="MOVIE_SCORE"           property="score"/>
        <result column="MOVIE_COMMENT"         property="comment"/>
        <result column="MOVIE_DIRECTOR"        property="director"/>
        <result column="MOVIE_ACTOR"           property="actor"/>
        <result column="MOVIE_TRAILER"         property="trailer"/>
        <result column="RELEASE_DATE_STR"      property="releaseDate"/>
        <result column="COMMON_CATEGORY_ID"    property="commonCategoryId"/>
        <result column="GENRE_NAME"            property="genreName"/>
    </resultMap>

    <sql id="BaseSelect">
        SELECT
        M.MOVIE_ID,
        M.MOVIE_POSTER,
        M.MOVIE_BACKDROP,
        M.MOVIE_TITLE,
        M.MOVIE_SCORE,
        M.MOVIE_COMMENT,
        M.MOVIE_DIRECTOR,
        M.MOVIE_ACTOR,
        M.MOVIE_TRAILER,
        TO_CHAR(M.MOVIE_DATE, 'YYYY-MM-DD') AS RELEASE_DATE_STR,
        M.COMMON_CATEGORY_ID,
        C.COMMON_CATEGORY_NAME AS GENRE_NAME
            FROM TB_MOVIE M
            LEFT JOIN TB_COMMON_CATEGORY C
            ON C.COMMON_CATEGORY_ID = M.COMMON_CATEGORY_ID
    </sql>

    <select id="selectPopular" parameterType="map" resultMap="MovieMap">
        SELECT * FROM (
        SELECT ROWNUM AS rn, t.* FROM (
        <include refid="BaseSelect"/>
        ORDER BY M.MOVIE_SCORE DESC NULLS LAST, M.MOVIE_DATE DESC
        ) t
        WHERE ROWNUM &lt;= #{offset} + #{limit}
        )
        WHERE rn &gt; #{offset}
    </select>

    <select id="selectLatest" parameterType="map" resultMap="MovieMap">
        SELECT * FROM (
        SELECT ROWNUM AS rn, t.* FROM (
        <include refid="BaseSelect"/>
        ORDER BY M.MOVIE_DATE DESC NULLS LAST, M.MOVIE_ID DESC
        ) t
        WHERE ROWNUM &lt;= #{offset} + #{limit}
        )
        WHERE rn &gt; #{offset}
    </select>

    <select id="selectById" parameterType="long" resultMap="MovieMap">
        <include refid="BaseSelect"/>
        WHERE M.MOVIE_ID = #{movieId}
    </select>

    <!-- TMDB 코드로 COMMON_CATEGORY_ID 조회 -->
    <select id="findCategoryIdByCode" resultType="string">
        SELECT COMMON_CATEGORY_ID
        FROM TB_COMMON_CATEGORY
        WHERE COMMON_CATEGORY_SYSTEM = #{system}
        AND COMMON_CATEGORY_CODE   = #{code}
        AND COMMON_CATEGORY_IS_ACTIVE = 'Y'
    </select>

    <!-- UPSERT -->
    <insert id="mergeMovie" parameterType="com.recharge.backend.movie.vo.MovieVO">
        MERGE INTO TB_MOVIE M
        USING (
        SELECT
        #{movieId,jdbcType=NUMERIC} AS MOVIE_ID,
        #{poster,jdbcType=VARCHAR} AS MOVIE_POSTER,
        #{backdrop,jdbcType=VARCHAR} AS MOVIE_BACKDROP,
        #{title,jdbcType=VARCHAR} AS MOVIE_TITLE,
        #{score,jdbcType=DOUBLE} AS MOVIE_SCORE,
        #{comment,jdbcType=VARCHAR} AS MOVIE_COMMENT,
        #{director,jdbcType=VARCHAR} AS MOVIE_DIRECTOR,
        #{actor,jdbcType=VARCHAR} AS MOVIE_ACTOR,
        #{trailer,jdbcType=VARCHAR} AS MOVIE_TRAILER,
        TO_DATE(#{releaseDate,jdbcType=VARCHAR}, 'YYYY-MM-DD') AS MOVIE_DATE,
        #{commonCategoryId,jdbcType=VARCHAR} AS COMMON_CATEGORY_ID
        FROM DUAL
        ) S
        ON (M.MOVIE_ID = S.MOVIE_ID)
        WHEN MATCHED THEN
        UPDATE SET
        M.MOVIE_POSTER = S.MOVIE_POSTER,
        M.MOVIE_BACKDROP = S.MOVIE_BACKDROP,
        M.MOVIE_TITLE = S.MOVIE_TITLE,
        M.MOVIE_SCORE = S.MOVIE_SCORE,
        M.MOVIE_COMMENT = S.MOVIE_COMMENT,
        M.MOVIE_DIRECTOR = S.MOVIE_DIRECTOR,
        M.MOVIE_ACTOR = S.MOVIE_ACTOR,
        M.MOVIE_TRAILER = S.MOVIE_TRAILER,
        M.MOVIE_DATE = S.MOVIE_DATE,
        M.COMMON_CATEGORY_ID = S.COMMON_CATEGORY_ID,
        M.UPDATED_DATE = SYSDATE,
        M.UPDATED_ID = 'system'
        WHEN NOT MATCHED THEN
        INSERT (
        MOVIE_ID, MOVIE_POSTER, MOVIE_BACKDROP, MOVIE_TITLE, MOVIE_SCORE,
        MOVIE_COMMENT, MOVIE_DIRECTOR, MOVIE_ACTOR, MOVIE_TRAILER,
        MOVIE_DATE, COMMON_CATEGORY_ID, CREATE_DATE, CREATE_ID, UPDATED_DATE, UPDATED_ID
        )
        VALUES (
        S.MOVIE_ID, S.MOVIE_POSTER, S.MOVIE_BACKDROP, S.MOVIE_TITLE, S.MOVIE_SCORE,
        S.MOVIE_COMMENT, S.MOVIE_DIRECTOR, S.MOVIE_ACTOR, S.MOVIE_TRAILER,
        S.MOVIE_DATE, S.COMMON_CATEGORY_ID, SYSDATE, 'system', SYSDATE, 'system'
        )
    </insert>


</mapper>
